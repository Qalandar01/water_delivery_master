<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Order Page</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="mask-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciLz4=" color="#000000">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; }
        #map {
            width:100%;
            height:850px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        /* ‚úÖ Make map cursor more obvious when hovering */
        #map .ymaps-2-1-79-placemark-overlay {
            cursor: pointer !important;
        }
        #map .ymaps-2-1-79-circle-overlay {
            cursor: pointer !important;
        }
        .my-row { display:flex; }
        .col-left {
            flex: 0 0 15%;
            max-width: 25%;
            padding: 10px;
            border-right: 1px solid #ccc;
            overflow-y: auto;
            max-height: 900px;
            background-color: white;
        }
        .col-right { flex: 0 0 84%; max-width: 85%; padding: 20px; }
        .text-muted { font-size:18px; font-weight:bold; text-align:center; color: #333; }
        .courier-card {
            transition: all .3s ease;
            margin-bottom:5px;
            cursor: pointer;
            border-radius: 8px;
        }
        .courier-card:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .courier-card.selected {
            border: 2px solid #198754;
            background-color:#e6f7ec;
            box-shadow: 0 4px 12px rgba(25,135,84,0.3);
        }
        .courier-card a { text-decoration: none; color: inherit; }
        .hide { display:none; }
        .legend-item {
            margin-bottom: 8px;
            padding: 5px 10px;
            background: white;
            border-radius: 4px;
            font-size: 14px;
        }
        .route-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .route-info h5 {
            margin: 0 0 10px 0;
            color: #333;
        }
        #alert-message {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" th:href="@{/}"><i class="fa-solid fa-home"></i> Home</a>
</nav>

<div class="my-row">
    <div class="col-left">
        <h2 class="text-muted">Couriers</h2>
        <div th:each="courier : ${couriers}" class="mb-3">
            <a th:href="|?courierId=${courier.id}|" style="text-decoration: none;">
                <div th:class="|card courier-card ${courier.id.equals(currentCourier.id) ? 'selected':''}|">
                    <div class="card-body">
                        <button class="btn btn-success btn-sm" type="button">
                            <i class="bi bi-person"></i>
                            <span th:text="${courier.fullName}">Name</span>
                        </button>
                        <div class="courier-info mt-2">
                            <small th:text="${courier.fullName}">Full Name</small>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <div class="col-right">
        <div class="route-info">
            <h5>üìç Current Route Plan</h5>
            <div id="routeSummary">
                <span class="text-muted">Click orders on map to build route...</span>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-4">
                <strong>Order Status Legend:</strong>
                <div class="legend-item">üü¢ Today's Orders</div>
                <div class="legend-item">üü† Yesterday's Orders</div>
                <div class="legend-item">üî¥ 2+ Days Old</div>
                <div class="legend-item">üü£ Selected for Route</div>
                <div class="legend-item">‚ö´ Assigned to Other Courier</div>
            </div>
            <div class="col-4">
                <label>
                    <input id="showAllCheckbox" checked type="checkbox" onchange="onChangeAll(this)"> Show All Orders
                </label>
                <input class="form-control mt-2" type="text" placeholder="Search by phone..." onkeyup="handleSearchOrders(this)">
            </div>
            <div class="col-2 offset-2">
                <form method="post" action="/operator/orders/assign" id="assignForm">
                    <input type="hidden" name="orders" id="ordersInput">
                    <input type="hidden" name="courierId" th:value="${currentCourier.id}">
                    <button type="submit" class="btn btn-success btn-block">
                        <i class="bi bi-check-circle"></i> Assign Orders
                    </button>
                </form>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div id="map"></div>
            </div>
        </div>
    </div>
</div>

<div id="alert-message" class="alert alert-warning alert-dismissible fade show hide" role="alert">
    <span id="alert-text"></span>
    <button type="button" class="close" onclick="hideAlert()">
        <span>&times;</span>
    </button>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script th:src="@{https://api-maps.yandex.ru/2.1/?apikey=${yandexMapsApiKey}&lang=en_US}"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    // Parse server data
    var orders = JSON.parse(/*[[${ordersJson}]]*/ "[]");
    var currentOrders = JSON.parse(/*[[${currentOrdersJson}]]*/ "[]");
    var couriers = JSON.parse(/*[[${couriersJson}]]*/ "[]");
    var company = JSON.parse(/*[[${companyJson}]]*/ "{}");
    var currentCourier = JSON.parse(/*[[${currentCourierJson}]]*/ "{}");

    // Global variables
    var map;
    var placemarks = [];
    var companyCoords = [company.latitude, company.longitude];

    // In-memory storage (no localStorage)
    var selectedIdsPerCourier = {};
    var selectedPointsPerCourier = {};

    // Initialize data structures
    function initializeData() {
        // Initialize for all couriers
        couriers.forEach(function(courier) {
            var courierId = String(courier.id);

            if (!selectedIdsPerCourier[courierId]) {
                selectedIdsPerCourier[courierId] = ['company'];
            }

            if (!selectedPointsPerCourier[courierId]) {
                var assignedOrders = currentOrders.filter(function(item) {
                    return item.courierId === courier.id;
                });

                if (assignedOrders.length > 0) {
                    var lastOrder = assignedOrders[assignedOrders.length - 1];
                    selectedPointsPerCourier[courierId] = [
                        [lastOrder.location.latitude, lastOrder.location.longitude]
                    ];
                } else {
                    selectedPointsPerCourier[courierId] = [companyCoords];
                }
            }
        });
    }

    // Initialize map
    ymaps.ready(function() {
        initializeData();
        initMap();
    });

    function initMap() {
        map = new ymaps.Map('map', {
            center: companyCoords,
            zoom: 13,
            controls: ['zoomControl', 'fullscreenControl']
        });

        var companyPlacemark = new ymaps.Placemark(companyCoords, {
            hintContent: 'Company Location - Click to reset route'
        }, {
            preset: 'islands#blueHomeIcon',
            iconColor: 'blue',
            cursor: 'pointer'
        });

        map.geoObjects.add(companyPlacemark);

        // ‚úÖ COMPANY CLICK: Reset/Undraw entire route
        companyPlacemark.events.add('click', function() {
            var assignedForCurrent = currentOrders.filter(function(item) {
                return item.courierId === currentCourier.id;
            });

            var key = String(currentCourier.id);

            // If courier has assigned orders, reset to last assigned position
            if (assignedForCurrent.length > 0) {
                var lastOrder = assignedForCurrent[assignedForCurrent.length - 1];
                selectedIdsPerCourier[key] = ['company'];
                selectedPointsPerCourier[key] = [
                    [lastOrder.location.latitude, lastOrder.location.longitude]
                ];
                showAlert('üîÑ Route reset to last assigned order');
            } else {
                // No assigned orders, reset to company
                selectedIdsPerCourier[key] = ['company'];
                selectedPointsPerCourier[key] = [companyCoords];
                showAlert('üîÑ Route completely reset');
            }

            reRenderMap();
        });

        renderOrders();
        renderOtherCouriersPolylines();
        renderCurrentCourierPolyline();
        renderAssignedOrdersLine();
    }

    function renderOrders() {
        // Remove existing order placemarks
        placemarks.forEach(function(p) {
            try {
                map.geoObjects.remove(p.placemark);
            } catch(e) {
                console.error('Error removing placemark:', e);
            }
        });
        placemarks = [];

        orders.forEach(function(order) {
            var lat = order.location && order.location.latitude;
            var lon = order.location && order.location.longitude;

            if (!lat || !lon) {
                console.warn('Order missing location:', order.id);
                return;
            }

            var color = getOrderColor(order);
            var hint = buildHint(order);

            if (order.status === 'ASSIGNED') {
                hint += buildUnassignButton(order.id);
            }

            // ‚úÖ Check if order is in current courier's planned route
            var key = String(currentCourier.id);
            var isInCurrentRoute = selectedIdsPerCourier[key] &&
                selectedIdsPerCourier[key].indexOf(order.id) !== -1;

            // ‚úÖ Choose icon preset based on order state
            var iconPreset = 'islands#circleIcon'; // Default: larger circle

            if (order.status === 'ASSIGNED') {
                iconPreset = 'islands#circleDotIcon';
            } else if (isInCurrentRoute) {
                iconPreset = 'islands#circleIcon';
            }

            // ‚úÖ BIGGER ICON OPTIONS for easier clicking
            var placemarkOptions = {
                preset: iconPreset,
                iconColor: color,
                cursor: 'pointer',
                hideIconOnBalloonOpen: false,
                openBalloonOnClick: false,
                zIndex: isInCurrentRoute ? 2000 : 1000,
                zIndexHover: 3000
            };

            // ‚úÖ Make icon bigger based on importance
            if (isInCurrentRoute) {
                // Selected orders get bigger icons
                placemarkOptions.iconImageSize = [45, 45];
                placemarkOptions.iconImageOffset = [-22, -45];
            } else {
                // Regular orders get medium icons
                placemarkOptions.iconImageSize = [35, 35];
                placemarkOptions.iconImageOffset = [-17, -35];
            }

            var placemark = new ymaps.Placemark([lat, lon], {
                hintContent: hint,
                balloonContent: hint
            }, placemarkOptions);

            // ‚úÖ Add larger invisible circle for better click detection
            var clickableCircle = new ymaps.Circle(
                [[lat, lon], 30], // 30 meter radius
                {},
                {
                    fillOpacity: 0,
                    strokeOpacity: 0,
                    cursor: 'pointer',
                    zIndex: 500
                }
            );

            // Both placemark and circle trigger the same click handler
            placemark.events.add('click', function() {
                handlePlacemarkClick(order, lat, lon);
            });

            clickableCircle.events.add('click', function() {
                handlePlacemarkClick(order, lat, lon);
            });

            placemarks.push({
                placemark: placemark,
                circle: clickableCircle,
                orderId: order.id
            });

            map.geoObjects.add(clickableCircle); // Add invisible circle first
            map.geoObjects.add(placemark); // Add visible marker on top
        });
    }

    function handlePlacemarkClick(order, lat, lon) {
        var key = String(currentCourier.id);
        var orderId = order.id;
        var point = [lat, lon];

        // Handle ASSIGNED orders (already saved to database)
        if (order.status === 'ASSIGNED') {
            var assignedOrders = currentOrders.filter(function(item) {
                return item.courierId === currentCourier.id;
            });

            if (assignedOrders.length > 0) {
                var lastOrder = assignedOrders[assignedOrders.length - 1];
                if (lastOrder.orderId === order.id) {
                    selectedIdsPerCourier[key] = ['company'];
                    selectedPointsPerCourier[key] = [
                        [lastOrder.location.latitude, lastOrder.location.longitude]
                    ];
                    reRenderMap();
                    showAlert('Start planning route from the last assigned order');
                } else {
                    showAlert('Can only modify route from the last assigned order');
                }
            }
            return;
        }

        // Check if order already assigned to another courier (in planning)
        var assignedToOther = false;
        for (var courierId in selectedIdsPerCourier) {
            if (courierId !== key && selectedIdsPerCourier[courierId].indexOf(orderId) !== -1) {
                assignedToOther = true;
                break;
            }
        }

        if (assignedToOther) {
            showAlert('This order is already assigned to another courier');
            return;
        }

        // Check if order is already in current courier's route
        var existingIndex = selectedIdsPerCourier[key].indexOf(orderId);

        if (existingIndex !== -1) {
            // ‚úÖ UNDRAW: Clicking an already selected order removes it and all after it
            console.log('üîô Undrawing from order #' + orderId + ' (index: ' + existingIndex + ')');

            // Keep only points up to (and including) the clicked order
            selectedPointsPerCourier[key] = selectedPointsPerCourier[key].slice(0, existingIndex + 1);
            selectedIdsPerCourier[key] = selectedIdsPerCourier[key].slice(0, existingIndex + 1);

            showAlert('Route trimmed to Order #' + orderId);
        } else {
            // ‚úÖ DRAW: Add new order to route
            console.log('‚ûï Adding order #' + orderId + ' to route');
            selectedPointsPerCourier[key].push(point);
            selectedIdsPerCourier[key].push(orderId);

            var routeLength = selectedIdsPerCourier[key].length - 1; // -1 for 'company'
            showAlert('Added Order #' + orderId + ' (Total: ' + routeLength + ' orders)');
        }

        reRenderMap();
    }

    function renderOtherCouriersPolylines() {
        couriers.forEach(function(courier) {
            if (courier.id === currentCourier.id) return;

            var locations = [companyCoords];
            var courierId = String(courier.id);

            // Add assigned orders
            currentOrders.filter(function(item) {
                return item.courierId === courier.id;
            }).forEach(function(item) {
                locations.push([item.location.latitude, item.location.longitude]);
            });

            // Add selected points
            if (selectedPointsPerCourier[courierId]) {
                locations = locations.concat(selectedPointsPerCourier[courierId]);
            }

            if (locations.length >= 2) {
                var polyline = new ymaps.Polyline(locations, {
                    hintContent: 'Route for ' + courier.firstName
                }, {
                    strokeColor: 'rgba(128,128,128,0.5)',
                    strokeWidth: 5,
                    strokeOpacity: 0.7
                });

                polyline.events.add('click', function() {
                    window.location.href = '?courier=' + courier.id;
                });

                map.geoObjects.add(polyline);
            }
        });
    }

    function renderCurrentCourierPolyline() {
        var key = String(currentCourier.id);
        var points = selectedPointsPerCourier[key];

        if (points && points.length >= 2) {
            var polyline = new ymaps.Polyline(points, {
                hintContent: 'Planned route for ' + currentCourier.firstName
            }, {
                strokeColor: '#0000FF',
                strokeWidth: 7,
                strokeOpacity: 0.8
            });
            map.geoObjects.add(polyline);
        }
    }

    function renderAssignedOrdersLine() {
        var locations = [companyCoords];

        var assignedOrders = currentOrders.filter(function(item) {
            return item.courierId === currentCourier.id;
        });

        assignedOrders.forEach(function(order) {
            locations.push([order.location.latitude, order.location.longitude]);
        });

        if (locations.length >= 2) {
            var polyline = new ymaps.Polyline(locations, {
                hintContent: 'Assigned orders for ' + currentCourier.firstName
            }, {
                strokeColor: '#00FF00',
                strokeWidth: 7,
                strokeOpacity: 0.8
            });
            map.geoObjects.add(polyline);
        }
    }

    function reRenderMap() {
        map.geoObjects.removeAll();

        // Re-add company marker with click handler
        var companyPlacemark = new ymaps.Placemark(companyCoords, {
            hintContent: 'Company Location - Click to reset route'
        }, {
            preset: 'islands#blueHomeIcon',
            iconColor: 'blue',
            cursor: 'pointer'
        });

        companyPlacemark.events.add('click', function() {
            var assignedForCurrent = currentOrders.filter(function(item) {
                return item.courierId === currentCourier.id;
            });

            var key = String(currentCourier.id);

            if (assignedForCurrent.length > 0) {
                var lastOrder = assignedForCurrent[assignedForCurrent.length - 1];
                selectedIdsPerCourier[key] = ['company'];
                selectedPointsPerCourier[key] = [
                    [lastOrder.location.latitude, lastOrder.location.longitude]
                ];
                showAlert('üîÑ Route reset to last assigned order');
            } else {
                selectedIdsPerCourier[key] = ['company'];
                selectedPointsPerCourier[key] = [companyCoords];
                showAlert('üîÑ Route completely reset');
            }

            reRenderMap();
        });

        map.geoObjects.add(companyPlacemark);

        renderOrders();
        renderOtherCouriersPolylines();
        renderCurrentCourierPolyline();
        renderAssignedOrdersLine();

        // ‚úÖ Show route sequence numbers
        renderRouteNumbers();
    }

    /**
     * ‚úÖ NEW: Show numbers on orders in the planned route
     */
    function renderRouteNumbers() {
        var key = String(currentCourier.id);
        var routeIds = selectedIdsPerCourier[key] || [];

        routeIds.forEach(function(orderId, index) {
            if (orderId === 'company') return; // Skip company

            var order = orders.find(function(o) { return o.id === orderId; });
            if (!order || !order.location) return;

            var sequenceNumber = index; // 0-based, but company is 0, so first order is 1

            var numberPlacemark = new ymaps.Placemark(
                [order.location.latitude, order.location.longitude],
                {
                    iconContent: String(sequenceNumber)
                },
                {
                    preset: 'islands#blueStretchyIcon',
                    cursor: 'pointer'
                }
            );

            numberPlacemark.events.add('click', function() {
                handlePlacemarkClick(order, order.location.latitude, order.location.longitude);
            });

            map.geoObjects.add(numberPlacemark);
        });

        // Update route summary panel
        updateRouteSummary();
    }

    /**
     * ‚úÖ NEW: Update the route summary panel
     */
    function updateRouteSummary() {
        var key = String(currentCourier.id);
        var routeIds = selectedIdsPerCourier[key] || [];
        var summaryDiv = document.getElementById('routeSummary');

        if (!summaryDiv) return;

        // Filter out 'company' from route
        var orderIds = routeIds.filter(function(id) { return id !== 'company'; });

        if (orderIds.length === 0) {
            summaryDiv.innerHTML = '<span class="text-muted">Click orders on map to build route...</span>';
            return;
        }

        var summaryHtml = '<strong>Route: </strong>';
        summaryHtml += '<span class="badge badge-info">Company</span> ‚Üí ';

        orderIds.forEach(function(orderId, index) {
            var order = orders.find(function(o) { return o.id === orderId; });
            if (order) {
                summaryHtml += '<span class="badge badge-primary" style="cursor:pointer;" onclick="highlightOrder(' + orderId + ')">';
                summaryHtml += (index + 1) + '. Order #' + orderId + '</span>';
                if (index < orderIds.length - 1) {
                    summaryHtml += ' ‚Üí ';
                }
            }
        });

        summaryHtml += '<br><small class="text-muted mt-2 d-block">Total: ' + orderIds.length + ' order(s) ‚Ä¢ Click order numbers to remove</small>';

        summaryDiv.innerHTML = summaryHtml;
    }

    /**
     * ‚úÖ NEW: Highlight an order on the map
     */
    function highlightOrder(orderId) {
        var pm = placemarks.find(function(p) { return p.orderId === orderId; });
        if (pm && pm.placemark) {
            map.setCenter(pm.placemark.geometry.getCoordinates(), 16);
            pm.placemark.balloon.open();
        }
    }

    function getOrderColor(order) {
        var key = String(currentCourier.id);
        var orderId = order.id;

        // ‚úÖ GRAY: Check if assigned to another courier (database assigned)
        if (order.status === 'ASSIGNED' && order.courierId !== currentCourier.id) {
            var assignedToCurrentCourier = currentOrders.some(function(co) {
                return co.orderId === orderId && co.courierId === currentCourier.id;
            });
            if (!assignedToCurrentCourier) {
                return 'gray';
            }
        }

        // ‚úÖ GRAY: Check if assigned to another courier (in planning)
        var assignedToOther = false;
        for (var courierId in selectedIdsPerCourier) {
            if (courierId !== key && selectedIdsPerCourier[courierId].indexOf(orderId) !== -1) {
                assignedToOther = true;
                break;
            }
        }

        if (assignedToOther) {
            return 'gray';
        }

        // ‚úÖ PURPLE: In current courier's planned route (not yet saved)
        if (selectedIdsPerCourier[key] && selectedIdsPerCourier[key].indexOf(orderId) !== -1) {
            return 'violet';
        }

        // ‚úÖ Date-based colors for available orders
        var orderDate = order.day;
        var today = new Date().toISOString().split('T')[0];
        var yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        yesterday = yesterday.toISOString().split('T')[0];

        if (orderDate === today) return 'green';
        if (orderDate === yesterday) return 'orange';
        return 'red';
    }

    function buildHint(order) {
        var productsHtml = '';
        if (order.products && order.products.length > 0) {
            productsHtml = order.products.map(function(p) {
                return '<li><span>' + p.name + '</span> x' + p.amount + '</li>';
            }).join('');
        }

        return '<div style="font-family:Arial;font-size:12px;padding:8px;max-width:250px;">' +
            '<div style="font-weight:bold;margin-bottom:4px;">üÜî Order #' + order.id + '</div>' +
            '<div style="margin-bottom:2px;">üìÖ ' + formatDate(order.date) + '</div>' +
            '<div style="margin-bottom:6px;">üìû ' + order.phone + '</div>' +
            '<ul style="margin:0;padding-left:20px;">' + productsHtml + '</ul>' +
            '</div>';
    }

    function buildUnassignButton(orderId) {
        return '<form action="/operator/orders/unassign" method="post" class="unassign-form" style="margin-top:8px;">' +
            '<input type="hidden" name="orderId" value="' + orderId + '">' +
            '<button type="submit" class="btn btn-danger btn-sm">üöö Release Order</button>' +
            '</form>';
    }

    function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        var d = new Date(dateStr);
        return d.toLocaleString();
    }

    function onChangeAll(checkbox) {
        var showAll = checkbox.checked;

        placemarks.forEach(function(pm) {
            try {
                map.geoObjects.remove(pm.placemark);
                if (pm.circle) map.geoObjects.remove(pm.circle);
            } catch(e) {}
        });

        if (showAll) {
            placemarks.forEach(function(pm) {
                if (pm.circle) map.geoObjects.add(pm.circle);
                map.geoObjects.add(pm.placemark);
            });
        } else {
            var key = String(currentCourier.id);

            placemarks.forEach(function(pm) {
                var order = orders.find(function(o) {
                    return o.id === pm.orderId;
                });

                if (!order) return;

                var selectedByCurrent = selectedIdsPerCourier[key].indexOf(order.id) !== -1;
                var notAssignedToAnyone = true;

                for (var courierId in selectedIdsPerCourier) {
                    if (selectedIdsPerCourier[courierId].indexOf(order.id) !== -1) {
                        notAssignedToAnyone = false;
                        break;
                    }
                }

                if (selectedByCurrent || notAssignedToAnyone) {
                    if (order.status === 'ASSIGNED') {
                        var assignedToOther = currentOrders.some(function(co) {
                            return co.orderId === order.id && co.courierId !== currentCourier.id;
                        });
                        if (assignedToOther) return;
                    }
                    if (pm.circle) map.geoObjects.add(pm.circle);
                    map.geoObjects.add(pm.placemark);
                }
            });
        }
    }

    function handleSearchOrders(input) {
        var searchValue = input.value.trim();
        resetPlacemarkStyles();

        if (!searchValue) return;

        var foundOrders = orders.filter(function(order) {
            return order.phone && order.phone.includes(searchValue);
        });

        if (foundOrders.length > 0) {
            var orderId = foundOrders[0].id;
            var pm = placemarks.find(function(p) {
                return p.orderId === orderId;
            });

            if (pm && pm.placemark) {
                var coords = pm.placemark.geometry.getCoordinates();
                map.setCenter(coords, 17); // Zoom in more for better visibility
                pm.placemark.options.set({
                    preset: 'islands#redCircleDotIcon',
                    iconImageSize: [50, 50],
                    iconImageOffset: [-25, -50]
                });

                // Pulse animation effect
                setTimeout(function() {
                    pm.placemark.options.set({
                        iconImageSize: [45, 45],
                        iconImageOffset: [-22, -45]
                    });
                }, 200);
            }
        } else {
            showAlert('No orders found with phone: ' + searchValue);
        }
    }

    function resetPlacemarkStyles() {
        placemarks.forEach(function(pm) {
            var key = String(currentCourier.id);
            var isInCurrentRoute = selectedIdsPerCourier[key] &&
                selectedIdsPerCourier[key].indexOf(pm.orderId) !== -1;

            var iconPreset = 'islands#circleIcon';
            var iconSize = isInCurrentRoute ? [45, 45] : [35, 35];
            var iconOffset = isInCurrentRoute ? [-22, -45] : [-17, -35];

            pm.placemark.options.set({
                preset: iconPreset,
                iconImageSize: iconSize,
                iconImageOffset: iconOffset
            });
        });
    }

    function showAlert(message) {
        var alertDiv = document.getElementById('alert-message');
        var alertText = document.getElementById('alert-text');
        alertText.textContent = message;
        alertDiv.classList.remove('hide');

        setTimeout(function() {
            hideAlert();
        }, 5000);
    }

    function hideAlert() {
        document.getElementById('alert-message').classList.add('hide');
    }

    // Form submission handler
    document.getElementById('assignForm').addEventListener('submit', function(e) {
        var key = String(currentCourier.id);
        var orderIds = selectedIdsPerCourier[key].slice(1); // Remove 'company'

        if (orderIds.length === 0) {
            e.preventDefault();
            showAlert('Please select at least one order to assign');
            return false;
        }

        document.getElementById('ordersInput').value = JSON.stringify(orderIds);
        return true;
    });

    // Handle unassign form submissions (delegated)
    document.addEventListener('submit', function(e) {
        if (e.target && e.target.classList.contains('unassign-form')) {
            // Reset data on unassign
            initializeData();
        }
    });

    // Debug logging
    console.log('=== MAP INITIALIZATION DEBUG ===');
    console.log('Total orders loaded:', orders.length);
    console.log('Total couriers:', couriers.length);
    console.log('Current courier:', currentCourier.firstName, '(ID:', currentCourier.id + ')');
    console.log('Currently assigned orders:', currentOrders.length);

    // Log order statuses
    var statusCount = {};
    orders.forEach(function(order) {
        statusCount[order.status] = (statusCount[order.status] || 0) + 1;
    });
    console.log('Orders by status:', statusCount);

    // Log orders with missing locations
    var noLocation = orders.filter(function(o) {
        return !o.location || !o.location.latitude || !o.location.longitude;
    });
    if (noLocation.length > 0) {
        console.warn('‚ö†Ô∏è Orders missing location data:', noLocation.length);
        noLocation.forEach(function(o) {
            console.warn('  - Order #' + o.id + ' has no location');
        });
    }

    // Log placemarks added to map
    console.log('Placemarks added to map:', placemarks.length);
    console.log('================================');
    /*]]>*/
</script>
</body>
</html>