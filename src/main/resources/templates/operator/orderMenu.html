<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Order Page</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; }
        #map {
            width:100%;
            height:850px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        /* ‚úÖ Make map cursor more obvious when hovering */
        #map .ymaps-2-1-79-placemark-overlay {
            cursor: pointer !important;
        }
        #map .ymaps-2-1-79-circle-overlay {
            cursor: pointer !important;
        }
        .my-row { display:flex; }
        .col-left {
            flex: 0 0 15%;
            max-width: 25%;
            padding: 10px;
            border-right: 1px solid #ccc;
            overflow-y: auto;
            max-height: 900px;
            background-color: white;
        }
        .col-right { flex: 0 0 84%; max-width: 85%; padding: 20px; }
        .text-muted { font-size:18px; font-weight:bold; text-align:center; color: #333; }
        .courier-card {
            transition: all .3s ease;
            margin-bottom:5px;
            cursor: pointer;
            border-radius: 8px;
        }
        .courier-card:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .courier-card.selected {
            border: 2px solid #198754;
            background-color:#e6f7ec;
            box-shadow: 0 4px 12px rgba(25,135,84,0.3);
        }
        .courier-card a { text-decoration: none; color: inherit; }
        .hide { display:none; }
        .legend-item {
            margin-bottom: 8px;
            padding: 5px 10px;
            background: white;
            border-radius: 4px;
            font-size: 14px;
        }
        .route-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .route-info h5 {
            margin: 0 0 10px 0;
            color: #333;
        }
        #alert-message {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" th:href="@{/}"><i class="fa-solid fa-home"></i> Home</a>
</nav>

<div class="my-row">
    <div class="col-left">
        <h2 class="text-muted">Couriers</h2>
        <div th:each="courier : ${couriers}" class="mb-3">
            <a th:href="|?courierId=${courier.id}|" style="text-decoration: none;">
                <div th:class="|card courier-card ${courier.id.equals(currentCourier.id) ? 'selected':''}|">
                    <div class="card-body">
                        <button class="btn btn-success btn-sm" type="button">
                            <i class="bi bi-person"></i>
                            <span th:text="${courier.fullName}">Name</span>
                        </button>
                        <div class="courier-info mt-2">
                            <small th:text="${courier.fullName}">Full Name</small>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <div class="col-right">
        <div class="route-info">
            <h5>üìç Current Route Plan</h5>
            <div id="routeSummary">
                <span class="text-muted">Click orders on map to build route...</span>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-4">
                <strong>Order Status Legend:</strong>
                <div class="legend-item">üü¢ Today's Orders</div>
                <div class="legend-item">üü† Yesterday's Orders</div>
                <div class="legend-item">üî¥ 2+ Days Old</div>
                <div class="legend-item">üü£ Selected for Route</div>
                <div class="legend-item">‚ö´ Assigned to Other Courier</div>
            </div>
            <div class="col-4">
                <label>
                    <input id="showAllCheckbox" checked type="checkbox" onchange="onChangeAll(this)"> Show All Orders
                </label>
                <input class="form-control mt-2" type="text" placeholder="Search by phone..." onkeyup="handleSearchOrders(this)">
            </div>
            <div class="col-2 offset-2">
                <form method="post" action="/operator/orders/assign" id="assignForm">
                    <input type="hidden" name="orders" id="ordersInput">
                    <input type="hidden" name="courierId" th:value="${currentCourier.id}">
                    <button type="submit" class="btn btn-success btn-block">
                        <i class="bi bi-check-circle"></i> Assign Orders
                    </button>
                </form>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div id="map"></div>
            </div>
        </div>
    </div>
</div>

<div id="alert-message" class="alert alert-warning alert-dismissible fade show hide" role="alert">
    <span id="alert-text"></span>
    <button type="button" class="close" onclick="hideAlert()">
        <span>&times;</span>
    </button>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script th:src="@{https://api-maps.yandex.ru/2.1/?apikey=${yandexMapsApiKey}&lang=en_US}"></script>

<script th:src="@{/js/order-map.js}"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    // Parse server data
    var orders = JSON.parse(/*[[${ordersJson}]]*/ "[]");
    var currentOrders = JSON.parse(/*[[${currentOrdersJson}]]*/ "[]");
    var couriers = JSON.parse(/*[[${couriersJson}]]*/ "[]");
    var company = JSON.parse(/*[[${companyJson}]]*/ "{}");
    var currentCourier = JSON.parse(/*[[${currentCourierJson}]]*/ "{}");

    // Global variables
    var map;
    var placemarks = [];
    var companyCoords = [company.latitude, company.longitude];

    // In-memory storage (no localStorage)
    var selectedIdsPerCourier = {};
    var selectedPointsPerCourier = {};

    ymaps.ready(function() {
        initializeData();
        initMap();
    });



    /**
     * ‚úÖ NEW: Update the route summary panel
     */


    // Form submission handler
    document.getElementById('assignForm').addEventListener('submit', function(e) {
        var key = String(currentCourier.id);
        var orderIds = selectedIdsPerCourier[key].slice(1); // Remove 'company'

        if (orderIds.length === 0) {
            e.preventDefault();
            showAlert('Please select at least one order to assign');
            return false;
        }

        document.getElementById('ordersInput').value = JSON.stringify(orderIds);
        return true;
    });

    // Handle unassign form submissions (delegated)
    document.addEventListener('submit', function(e) {
        if (e.target && e.target.classList.contains('unassign-form')) {
            // Reset data on unassign
            initializeData();
        }
    });

    // Debug logging
    console.log('=== MAP INITIALIZATION DEBUG ===');
    console.log('Total orders loaded:', orders.length);
    console.log('Total couriers:', couriers.length);
    console.log('Current courier:', currentCourier.firstName, '(ID:', currentCourier.id + ')');
    console.log('Currently assigned orders:', currentOrders.length);

    // Log order statuses
    var statusCount = {};
    orders.forEach(function(order) {
        statusCount[order.status] = (statusCount[order.status] || 0) + 1;
    });
    console.log('Orders by status:', statusCount);

    // Log orders with missing locations
    var noLocation = orders.filter(function(o) {
        return !o.location || !o.location.latitude || !o.location.longitude;
    });
    if (noLocation.length > 0) {
        console.warn('‚ö†Ô∏è Orders missing location data:', noLocation.length);
        noLocation.forEach(function(o) {
            console.warn('  - Order #' + o.id + ' has no location');
        });
    }

    // Log placemarks added to map
    console.log('Placemarks added to map:', placemarks.length);
    console.log('================================');
    /*]]>*/
</script>
</body>
</html>